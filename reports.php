<?php
// ุฅุนุฏุงุฏุงุช ุงูุฌูุณุฉ ุงูุขููุฉ
ini_set('session.cookie_httponly', 1);
ini_set('session.use_strict_mode', 1);
if (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on') {
    ini_set('session.cookie_secure', 1);
}
session_start(['cookie_httponly' => true, 'cookie_secure' => isset($_SERVER['HTTPS']), 'use_strict_mode' => true]);

require_once 'dbconnection.php';
header('Content-Type: charset=utf-8');
// ุงูุชุญูู ูู ุงูุฌูุณุฉ
if (!isset($_SESSION['aid']) || !filter_var($_SESSION['aid'], FILTER_VALIDATE_INT)) {
    header('Location: logout.php');
    exit();
}
$aid = (int) $_SESSION['aid'];
// ุงูุชุญูู ูู ุตูุงุญูุฉ ุงููุฏูุฑ
$stmt = $con->prepare("SELECT level FROM tbl_login WHERE id =?");
$stmt->bind_param("i", $aid);
$stmt->execute();
$result = $stmt->get_result();
$user = $result->fetch_assoc();
$stmt->close();
if (!isset($user) || (int)$user['level'] <= 2) {
    echo '<script>alert("ุนููุงุ ูุง ุชููู ุตูุงุญูุงุช ูุงููุฉ")</script>';
    echo "<script>window.location.href='index.php'</script>";
    exit();
}
// --- ููุทู ุงูููุชุฑุฉ ---
$where_clause = " WHERE 1=1 ";
$params = [];
$param_types = '';
$filter_title = "ุงูุชูุงุฑูุฑ ุงูุดุงููุฉ (ูู ุงูุฃููุงุช)";

if (!empty($_GET['report_date'])) {
    $report_date = $_GET['report_date'];
    $where_clause = " WHERE DATE(come_date) = ? ";
    $params = [$report_date];
    $param_types = 's';
    $filter_title = "ุชูุฑูุฑ ููู: " . htmlspecialchars($report_date);
} elseif (isset($_GET['current_month'])) {
    $start_date = date('Y-m-01');
    $end_date = date('Y-m-t');
    $where_clause = " WHERE come_date BETWEEN ? AND ? ";
    $params = [$start_date, $end_date];
    $param_types = 'ss';
    $filter_title = "ุชูุงุฑูุฑ ุงูุดูุฑ ุงูุญุงูู (" .formatDate(date('F Y')) . ")";
} elseif (isset($_GET['current_year'])) {
    $start_date = date('Y-01-01');
    $end_date = date('Y-12-31');
    $where_clause = " WHERE come_date BETWEEN ? AND ? ";
    $params = [$start_date, $end_date];
    $param_types = 'ss';
    $filter_title = "ุชูุงุฑูุฑ ุงูุณูุฉ ุงูุญุงููุฉ (" . date('Y') . ")";
}
function formatDate($date) {
    $timestamp = strtotime($date);
    $day = date("j", $timestamp);
    $month = date("M", $timestamp);
    $year = date("Y", $timestamp);

    $months = [
        'Jan' => 'ููุงูุฑ', 'Feb' => 'ูุจุฑุงูุฑ', 'Mar' => 'ูุงุฑุณ', 'Apr' => 'ุฃุจุฑูู',
        'May' => 'ูุงูู', 'Jun' => 'ููููู', 'Jul' => 'ููููู', 'Aug' => 'ุฃุบุณุทุณ',
        'Sep' => 'ุณุจุชูุจุฑ', 'Oct' => 'ุฃูุชูุจุฑ', 'Nov' => 'ููููุจุฑ', 'Dec' => 'ุฏูุณูุจุฑ'
    ];

    return $day . " " . $months[$month] . " " . $year;
}
// --- ุงุณุชุนูุงู ููุญุฏ ููุจูุงูุงุช ุงููุงููุฉ ุญุณุจ ุงูููุชุฑ ---
$financial_summary = [
    'total_bookings' => 0,
    'total_revenue' => 0,
    'total_tax' => 0,
    'total_discount' => 0,
];

$sql_financial = "SELECT 
                    COUNT(*) as total_bookings,
                    IFNULL(SUM(amount), 0) as total_revenue,
                    IFNULL(SUM(amount * tax / 100), 0) as total_tax,
                    IFNULL(SUM(amount * discount / 100), 0) as total_discount
                  FROM customers" . $where_clause;

$stmt = $con->prepare($sql_financial);
if (!empty($params)) {
    $stmt->bind_param($param_types, ...$params);
}
$stmt->execute();
$result = $stmt->get_result();
if ($result) {
    $financial_summary = $result->fetch_assoc();
}
$stmt->close();

// --- ุงุณุชุนูุงู ูุจูุงูุงุช ุงูุฑุณู ุงูุจูุงูู ุงููููู ---
$daily_labels = [];
$daily_revenue_data = [];
$daily_tax_data = [];

$sql_daily = "SELECT 
                DATE(come_date) as day, 
                SUM(amount) as daily_revenue, 
                SUM(amount * tax / 100) as daily_tax
              FROM customers" . $where_clause . " GROUP BY DATE(come_date) ORDER BY day ASC";
              
$stmt_daily = $con->prepare($sql_daily);
if (!empty($params)) {
    $stmt_daily->bind_param($param_types, ...$params);
}
$stmt_daily->execute();
$result_daily = $stmt_daily->get_result();
while ($row = $result_daily->fetch_assoc()) {
    $daily_labels[] = $row['day'];
    $daily_revenue_data[] = $row['daily_revenue'];
    $daily_tax_data[] = $row['daily_tax'];
}
$stmt_daily->close();

$sql_payment = "SELECT payment_method, SUM(amount) AS total_amount FROM customers". $where_clause. " GROUP BY payment_method";
$stmt_payment = $con->prepare($sql_payment);

if (!empty($params)) {
    $stmt_payment->bind_param($param_types,...$params);
}

$stmt_payment->execute();
$result_payment = $stmt_payment->get_result();

$paymentLabels = [];
$paymentValues = [];
$paymentCounts = [];

$sql_payment = "SELECT payment_method, COUNT(*) AS count, SUM(amount) AS total_amount
                FROM customers". $where_clause. "
                GROUP BY payment_method";

$stmt_payment = $con->prepare($sql_payment);
if (!empty($params)) {
    $stmt_payment->bind_param($param_types,...$params);
}
$stmt_payment->execute();
$result_payment = $stmt_payment->get_result();

while ($row = $result_payment->fetch_assoc()) {
    $paymentLabels[] = $row['payment_method'];
    $paymentValues[] = round($row['total_amount'], 2);
    $paymentCounts[] = $row['count'];
}
$stmt_payment->close();
// --- ุงุณุชุนูุงู ุญุงูุฉ ุงูุบุฑู (ุฏุงุฆูุงู ูุนุฑุถ ุงูุญุงูุฉ ุงูุญุงููุฉ) ---
$room_counts = ['ูุชุงุญุฉ' => 0, 'ูุญุฌูุฒุฉ' => 0, 'total' => 0];
$sql_rooms = "SELECT current_status, COUNT(*) as count FROM rooms GROUP BY current_status";
$result_rooms = $con->query($sql_rooms);
while ($row = $result_rooms->fetch_assoc()) {
    if (isset($room_counts[$row['current_status']])) {
        $room_counts[$row['current_status']] = $row['count'];
    }
}
$room_counts['total'] = $room_counts['ูุชุงุญุฉ'] + $room_counts['ูุญุฌูุฒุฉ'];
$room_status_labels = ['ูุชุงุญุฉ', 'ูุญุฌูุฒุฉ'];
$room_status_values = [$room_counts['ูุชุงุญุฉ'], $room_counts['ูุญุฌูุฒุฉ']];

?>
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title><?= htmlspecialchars($site["title"], ENT_QUOTES, 'UTF-8')?> - ุงูุชูุงุฑูุฑ</title>
  <?php include "header.php";?>
</head>
<body class="p-4">
<div class="container-fluid">
    <div class="row">
        <div class="col-md-3"><?php include "leftbar.php";?></div>
        <div class="col-md-9">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">๐ ุงูุชูุงุฑูุฑ</h2>
                <button class="btn btn-outline-primary" onclick="generatePDF()"><i class="fa fa-file-pdf-o"></i> ุชุตุฏูุฑ ุฅูู PDF</button>
            </div>

            <!-- ูุณู ุงูููุชุฑุฉ -->
            <div class="card mb-4">
                <div class="card-header">
                    ููุชุฑุฉ ุงูุชูุงุฑูุฑ
                </div>
              <div class="table-responsive" ><div class="card-body">
                    <form method="GET" class="row g-3 align-items-center">
                        <div class="col-md-4">
                            <label for="report_date" class="form-label">ุนุฑุถ ุชูุฑูุฑ ูุชุงุฑูุฎ ูุญุฏุฏ:</label>
                            <input type="date" name="report_date" id="report_date" class="form-control" value="<?= htmlspecialchars($_GET['report_date'] ?? '') ?>">
                        </div>
                        <div class="col-md-8 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">ุนุฑุถ ุงูุชูุฑูุฑ</button>
                            <a href="reports.php?current_month=1" class="btn btn-info me-2">ุงูุดูุฑ ุงูุญุงูู</a>
                            <a href="reports.php?current_year=1" class="btn btn-warning me-2">ุงูุณูุฉ ุงูุญุงููุฉ</a>
                            <a href="reports.php" class="btn btn-secondary">ุนุฑุถ ุงููู</a>
                        </div>
                    </form>
                </div></div>
            </div>

            <!-- ููุง ูุจุฏุฃ ุงููุญุชูู ุงูุฐู ุณูุชู ุชุตุฏูุฑู -->
            <div id="reportContent">
                <h3 class="mb-4 text-center p-3 bg-custom rounded"><?= htmlspecialchars($filter_title) ?></h3>

                <!-- ุงูุจุทุงูุงุช ุงูุนูููุฉ -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3"><div class="card text-center p-3 shadow-sm"><h6>ุฅุฌูุงูู ุงูุญุฌูุฒุงุช</h6><h3 class="text-primary"><?= $financial_summary['total_bookings'] ?></h3></div></div>
                    <div class="col-md-3"><div class="card text-center p-3
                    shadow-sm"><h6>ุฅุฌูุงูู ูุจูุนุงุช</h6><h3 class="text-success"><?=
                    number_format($financial_summary['total_revenue'], 2) ?>
                    $</h3></div></div>
                    <div class="col-md-3"><div class="card text-center p-3
                    shadow-sm"><h6>ุงุณุงุณ ุงูุถุฑูุจุฉ 78% </h6><h3
                    class="text-danger"><?=
                    number_format($financial_summary['total_revenue']*(1-0.22), 2) ?>
                    $</h3></div></div>
                    <div class="col-md-3"><div class="card text-center p-3 shadow-sm"><h6>ุฅุฌูุงูู ุงูุฎุตููุงุช</h6><h3 class="text-warning"><?= number_format($financial_summary['total_discount'], 2) ?> $</h3></div></div>
                </div>

                <!-- ุงูุฑุณู ุงูุจูุงูู ุงููููู ูุชูุฑูุฑ ุงูุบุฑู -->
                <div class="row g-4 mb-4">
                    <div class="col-md-8">
            <div class="card p-3 shadow-sm mb-4">
    <h6><i class="fa fa-bar-chart"></i> ุฅุฌูุงูู ุงููุจุงูุบ ุญุณุจ ุทุฑู ุงูุฏูุน</h6>
    <canvas id="paymentBarChart"></canvas>
 <div class="card p-3 shadow-sm mb-4">
    <h6><i class="fa fa-credit-card"></i> ุทุฑู ุงูุฏูุน ุงููุณุชุฎุฏูุฉ</h6>

    <ul class="list-group list-group-flush mt-3">
        <?php for ($i = 0; $i < count($paymentLabels); $i++):?>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <?= htmlspecialchars($paymentLabels[$i], ENT_QUOTES, 'UTF-8')?>
                <span class="badge bg-custom rounded-pill">
                    <?= number_format($paymentCounts[$i])?> ุนูููุฉ / <?= number_format($paymentValues[$i], 2)?> ุฌ
                </span>
            </li>
        <?php endfor;?>
    </ul>
</div>                       </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card p-3 shadow-sm h-100">
                             <h6><i class="fa fa-pie-chart"></i> ุชูุฑูุฑ ุญุงูุฉ ุงูุบุฑู (ุงูุญุงููุฉ)</h6>
                            <canvas id="roomStatusChart"></canvas>
                            <ul class="list-group list-group-flush mt-3">
                                <li class="list-group-item d-flex justify-content-between align-items-center">ูุชุงุญุฉ <span class="badge bg-success rounded-pill"><?= $room_counts['ูุชุงุญุฉ'] ?></span></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">ูุญุฌูุฒุฉ <span class="badge bg-danger rounded-pill"><?= $room_counts['ูุญุฌูุฒุฉ'] ?></span></li>
                                <li class="list-group-item d-flex
                                justify-content-between align-items-center
                                fw-bold">ุงูุฅุฌูุงูู <span class="badge bg-custom rounded-pill"><?= $room_counts['total']
                                ?></span></li>
                            </ul>
                        
                        </div>
                    </div>
                </div>
        </div>
    </div>
</div>

<?php include "footer.php";?>
<script>
// ุงูุฑุณู ุงูุจูุงูู ุงููููู ููุฅูุฑุงุฏุงุช ูุงูุถุฑุงุฆุจ
const ctxDaily = document.getElementById('dailyFinancialChart');
new Chart(ctxDaily, {
  type: 'line',
  data: {
    labels: <?= json_encode($daily_labels) ?>,
    datasets: [{
      label: 'ุงูุฅูุฑุงุฏุงุช ุงูููููุฉ',
      data: <?= json_encode($daily_revenue_data) ?>,
      borderColor: 'rgba(75, 192, 192, 1)',
      backgroundColor: 'rgba(75, 192, 192, 0.2)',
      fill: true,
      tension: 0.1
    },
    {
      label: 'ุงูุถุฑุงุฆุจ ุงูููููุฉ',
      data: <?= json_encode($daily_tax_data) ?>,
      borderColor: 'rgba(255, 99, 132, 1)',
      backgroundColor: 'rgba(255, 99, 132, 0.2)',
      fill: true,
      tension: 0.1
    }]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { position: 'top' },
      title: { display: false }
    }
  }
});

// ุงูุฑุณู ุงูุจูุงูู ูุญุงูุฉ ุงูุบุฑู
const ctxRooms = document.getElementById('roomStatusChart');
new Chart(ctxRooms, {
  type: 'doughnut',
  data: {
    labels: <?= json_encode($room_status_labels) ?>,
    datasets: [{
      label: 'ุญุงูุฉ ุงูุบุฑู',
      data: <?= json_encode($room_status_values) ?>,
      backgroundColor: ['#28a745', '#dc3545'],
      hoverOffset: 4
    }]
  }
});

// ูุธููุฉ ุชุตุฏูุฑ PDF
function generatePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'pt', 'a4');
  
  // ูุถูุงู ุฏุนู ุงููุบุฉ ุงูุนุฑุจูุฉุ ููุถู ุงุณุชุฎุฏุงู ุฎุท ูุฏุนููุง
  // ูุฐู ุงูุฎุทูุฉ ุชุชุทูุจ ุชุถููู ุงูุฎุท ูู ุงููุดุฑูุน
  // doc.addFont('Amiri-Regular.ttf', 'Amiri', 'normal');
  // doc.setFont('Amiri');

  const element = document.getElementById("reportContent");

  html2canvas(element, {
    scale: 2, // ุฌูุฏุฉ ุฃุนูู
    useCORS: true,
    // ุงูุณูุงุญ ุจุชูุณูู ุงููุญุชูู ุงูุทููู ุนูู ุนุฏุฉ ุตูุญุงุช
    windowHeight: element.scrollHeight 
  }).then(canvas => {
    const imgData = canvas.toDataURL("image/png");
    const pageWidth = doc.internal.pageSize.getWidth();
    // const pageHeight = doc.internal.pageSize.getHeight(); // ุบูุฑ ูุณุชุฎุฏู ูุจุงุดุฑุฉ ููุง

    // ุญุณุงุจ ุงูุฃุจุนุงุฏ ููุญูุงุธ ุนูู ูุณุจุฉ ุงูุนุฑุถ ุฅูู ุงูุงุฑุชูุงุน
    const canvasWidth = canvas.width;
    const canvasHeight = canvas.height;
    const ratio = canvasWidth / canvasHeight;
    const imgWidth = pageWidth - 40; // ูุน ููุงูุด
    const imgHeight = imgWidth / ratio;
    
    let heightLeft = imgHeight;
    let position = 20; // ุงููุงูุด ุงูุนููู

    doc.addImage(imgData, 'PNG', 20, position, imgWidth, imgHeight);
    heightLeft -= doc.internal.pageSize.getHeight();

    // ุฅุถุงูุฉ ุตูุญุงุช ุฌุฏูุฏุฉ ุฅุฐุง ูุงู ุงููุญุชูู ุฃุทูู ูู ุตูุญุฉ ูุงุญุฏุฉ
    while (heightLeft > 0) {
      position = -imgHeight + heightLeft;
      doc.addPage();
      doc.addImage(imgData, 'PNG', 20, position, imgWidth, imgHeight);
      heightLeft -= doc.internal.pageSize.getHeight();
    }
    
    doc.save("ุชูุฑูุฑ-ุงููุชุฑุฉ-ุงููุญุฏุฏุฉ.pdf");
  });
}
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const ctx = document.getElementById('paymentBarChart').getContext('2d');

    const labels = <?= json_encode($paymentLabels, JSON_UNESCAPED_UNICODE);?>;
    const data = <?= json_encode($paymentValues);?>;

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'ุฅุฌูุงูู ุงููุจูุบ (ุฌููู)',
                data: data,
                backgroundColor:['#34aaf7', '#065589'],
                borderColor: '#0056b3',
                borderWidth: 1
}]
},
        options: {
            responsive: true,
            plugins: {
                legend: { display: false},
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            return `${context.label}: ${context.parsed.toLocaleString()} ุฌููู`;
}
}
}
},
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function (value) {
                            return value.toLocaleString() + ' ุฌ';
}
}
}
}
}
});
});
</script>
</body>
</html>